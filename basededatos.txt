-- SISTEMA HELPDESK - ESQUEMA COMPLETO
            -- ======================================

            -- 1. PERFILES (Usuarios del sistema)
            CREATE TABLE IF NOT EXISTS profiles (
            id UUID REFERENCES auth.users(id) PRIMARY KEY,
            email TEXT UNIQUE NOT NULL,
            full_name TEXT,
            role TEXT DEFAULT 'user' CHECK (role IN ('admin', 'agent', 'user')),
            avatar_url TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
            );

            -- 2. CATEGOR√çAS (Tipos de tickets)
            CREATE TABLE IF NOT EXISTS categories (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            name TEXT NOT NULL UNIQUE,
            description TEXT,
            color TEXT DEFAULT '#2563eb',
            icon TEXT DEFAULT 'help-circle',
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
            );

            -- 3. TICKETS (Solicitudes principales)
            CREATE TABLE IF NOT EXISTS tickets (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            title TEXT NOT NULL,
            description TEXT NOT NULL,
            status TEXT DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'resolved', 'closed')),
            priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'urgent')),
            
            -- Relaciones
            created_by UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
            assigned_to UUID REFERENCES profiles(id) ON DELETE SET NULL,
            category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
            
            -- Fechas
            due_date TIMESTAMP WITH TIME ZONE,
            completed_at TIMESTAMP WITH TIME ZONE,
            
            -- M√≥dulo espec√≠fico
            module TEXT DEFAULT 'support' CHECK (module IN ('purchases', 'errors', 'support', 'other')),
            purchase_details JSONB DEFAULT '{}',
            error_details JSONB DEFAULT '{}',
            
            -- Metadatos
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
            );

            -- 4. COMENTARIOS (Conversaciones de tickets)
            CREATE TABLE IF NOT EXISTS comments (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            ticket_id UUID REFERENCES tickets(id) ON DELETE CASCADE NOT NULL,
            user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
            content TEXT NOT NULL,
            is_internal BOOLEAN DEFAULT false,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
            );

            -- 5. HISTORIAL (Auditor√≠a de cambios)
            CREATE TABLE IF NOT EXISTS ticket_history (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            ticket_id UUID REFERENCES tickets(id) ON DELETE CASCADE NOT NULL,
            changed_by UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
            field_changed TEXT NOT NULL,
            old_value TEXT,
            new_value TEXT,
            change_date TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
            );

            -- ======================================
            -- DATOS INICIALES
            -- ======================================

            -- Insertar categor√≠as por defecto
            INSERT INTO categories (name, description, color, icon) VALUES
            ('Error de Sistema', 'Problemas t√©cnicos y bugs del sistema', '#ef4444', 'bug'),
            ('Solicitud de Compra', 'Compra de materiales, equipos o servicios', '#10b981', 'shopping-cart'),
            ('Soporte T√©cnico', 'Asistencia con software, hardware o red', '#3b82f6', 'headphones'),
            ('Desarrollo', 'Nuevas funcionalidades o mejoras', '#8b5cf6', 'code'),
            ('General', 'Otras solicitudes no categorizadas', '#6b7280', 'help-circle')
            ON CONFLICT (name) DO NOTHING;

            -- ======================================
            -- √çNDICES (Mejora rendimiento)
            -- ======================================

            -- √çndices para b√∫squedas frecuentes
            CREATE INDEX IF NOT EXISTS idx_tickets_status ON tickets(status);
            CREATE INDEX IF NOT EXISTS idx_tickets_priority ON tickets(priority);
            CREATE INDEX IF NOT EXISTS idx_tickets_created_by ON tickets(created_by);
            CREATE INDEX IF NOT EXISTS idx_tickets_assigned_to ON tickets(assigned_to);
            CREATE INDEX IF NOT EXISTS idx_tickets_due_date ON tickets(due_date);
            CREATE INDEX IF NOT EXISTS idx_tickets_created_at ON tickets(created_at);

            -- √çndices para comentarios
            CREATE INDEX IF NOT EXISTS idx_comments_ticket_id ON comments(ticket_id);
            CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);

            -- ======================================
            -- SEGURIDAD (RLS - Row Level Security)
            -- ======================================

            -- Habilitar RLS en todas las tablas
            ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
            ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
            ALTER TABLE tickets ENABLE ROW LEVEL SECURITY;
            ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
            ALTER TABLE ticket_history ENABLE ROW LEVEL SECURITY;

            -- POL√çTICAS PARA PROFILES
            -- Todos pueden ver perfiles
            CREATE POLICY "Ver perfiles p√∫blicos" ON profiles
            FOR SELECT USING (true);

            -- Usuarios solo pueden actualizar SU perfil
            CREATE POLICY "Actualizar propio perfil" ON profiles
            FOR UPDATE USING (auth.uid() = id);

            -- POL√çTICAS PARA TICKETS
            -- Todos pueden ver tickets
            CREATE POLICY "Ver tickets p√∫blicos" ON tickets
            FOR SELECT USING (true);

            -- Usuarios pueden crear tickets
            CREATE POLICY "Crear tickets" ON tickets
            FOR INSERT WITH CHECK (auth.uid() = created_by);

            -- Reglas de actualizaci√≥n:
            -- 1. Creador puede editar
            -- 2. Asignado puede editar  
            -- 3. Admins/Agents pueden editar
            CREATE POLICY "Actualizar tickets autorizados" ON tickets
            FOR UPDATE USING (
                auth.uid() = created_by OR 
                auth.uid() = assigned_to OR
                EXISTS (
                SELECT 1 FROM profiles 
                WHERE id = auth.uid() AND role IN ('admin', 'agent')
                )
            );

            -- POL√çTICAS PARA COMENTARIOS
            -- Ver comentarios no internos o si eres parte del ticket
            CREATE POLICY "Ver comentarios autorizados" ON comments
            FOR SELECT USING (
                NOT is_internal OR 
                auth.uid() IN (
                SELECT created_by FROM tickets WHERE id = ticket_id
                UNION
                SELECT assigned_to FROM tickets WHERE id = ticket_id
                ) OR
                EXISTS (
                SELECT 1 FROM profiles 
                WHERE id = auth.uid() AND role IN ('admin', 'agent')
                )
            );

            -- Crear comentarios si tienes acceso al ticket
            CREATE POLICY "Crear comentarios autorizados" ON comments
            FOR INSERT WITH CHECK (
                auth.uid() IN (
                SELECT created_by FROM tickets WHERE id = ticket_id
                UNION
                SELECT assigned_to FROM tickets WHERE id = ticket_id
                ) OR
                EXISTS (
                SELECT 1 FROM profiles 
                WHERE id = auth.uid() AND role IN ('admin', 'agent')
                )
            );

            -- ======================================
            -- FUNCIONES Y TRIGGERS
            -- ======================================

            -- Funci√≥n para auto-actualizar updated_at
            CREATE OR REPLACE FUNCTION update_updated_at_column()
            RETURNS TRIGGER AS $$
            BEGIN
            NEW.updated_at = NOW();
            RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;

            -- Trigger para tickets
            CREATE TRIGGER trigger_update_tickets_updated_at
            BEFORE UPDATE ON tickets
            FOR EACH ROW
            EXECUTE FUNCTION update_updated_at_column();

            -- Funci√≥n para crear perfil autom√°ticamente
            CREATE OR REPLACE FUNCTION public.handle_new_user()
            RETURNS TRIGGER AS $$
            BEGIN
            INSERT INTO public.profiles (id, email, created_at)
            VALUES (NEW.id, NEW.email, NEW.created_at)
            ON CONFLICT (id) DO NOTHING;
            RETURN NEW;
            END;
            $$ LANGUAGE plpgsql SECURITY DEFINER;

            -- Trigger para nuevo usuario
            CREATE OR REPLACE TRIGGER on_auth_user_created
            AFTER INSERT ON auth.users
            FOR EACH ROW
            EXECUTE FUNCTION public.handle_new_user();

-- ======================================
üìä RESUMEN DE TABLAS DEL SISTEMA HELPDESK (5 Tablas)
        Ver la descripcion de las

        PROFILES, CATEGORIES, TICKETS, COMMENTS, TICKET_HISTORY

        PROFILES (Perfiles de Usuarios)
        Descripci√≥n: Informaci√≥n extendida de usuarios del sistema

        Campo	        Tipo	    Descripci√≥n
        id	            UUID	    ID √∫nico (igual a auth.users)
        email	        TEXT	    Correo del usuario
        full_name	    TEXT	    Nombre completo
        role	        TEXT	    Rol: admin/agent/user
        avatar_url	    TEXT	    URL de la foto de perfil
        created_at	    TIMESTAMP	Fecha de creaci√≥n

        CATEGORIES (Categor√≠as de Tickets)
        Descripci√≥n: Tipos o clasificaciones de tickets

        Campo	            Tipo	    Descripci√≥n
        id	                UUID	    ID √∫nico
        name	            TEXT	    Nombre de la categor√≠a
        description	        TEXT	    Descripci√≥n breve
        color	            TEXT	    Color para UI (hex)
        icon	            TEXT	    √çcono Bootstrap
        created_at	        TIMESTAMP	Fecha de creaci√≥n

        üìå Categor√≠as iniciales:
                Error de Sistema üêõ
                Solicitud de Compra üõí
                Soporte T√©cnico üéß
                Desarrollo üíª
                General ‚ùì

        TICKETS (Tickets/Solicitudes)
        Descripci√≥n: Tickets principales del sistema
        Campo	            Tipo	    Descripci√≥n
        id	                UUID	    ID √∫nico del ticket
        title	            TEXT	    T√≠tulo breve
        description	        TEXT	    Descripci√≥n detallada
        status	            TEXT	    Estado: open/in_progress/resolved/closed
        priority	        TEXT	    Prioridad: low/medium/high/urgent
        created_by	        UUID	    Usuario que cre√≥ (FK ‚Üí profiles)
        assigned_to	        UUID	    Usuario asignado (FK ‚Üí profiles)
        category_id	        UUID	    Categor√≠a (FK ‚Üí categories)
        due_date	        TIMESTAMP	Fecha l√≠mite
        completed_at	    TIMESTAMP	Fecha de resoluci√≥n
        module	            TEXT	    M√≥dulo: purchases/errors/support/other
        purchase_details	JSONB	    Datos espec√≠ficos para compras
        error_details	    JSONB	    Datos espec√≠ficos para errores
        created_at	        TIMESTAMP	Fecha creaci√≥n
        updated_at	        TIMESTAMP	√öltima actualizaci√≥n

        COMMENTS (Comentarios)
        Descripci√≥n: Conversaciones y comentarios sobre tickets

        Campo	            Tipo	    Descripci√≥n
        id	                UUID	    ID √∫nico
        ticket_id	        UUID	    Ticket relacionado (FK ‚Üí tickets)
        user_id	            UUID	    Usuario que comenta (FK ‚Üí profiles)
        content	            TEXT	    Contenido del comentario
        is_internal	        BOOLEAN	    Si es comentario interno (solo agentes)
        created_at	        TIMESTAMP	Fecha del comentario

        TICKET_HISTORY (Historial)
        Descripci√≥n: Auditor√≠a y seguimiento de cambios en tickets

        Campo	            Tipo	    Descripci√≥n
        id	                UUID	    ID √∫nico
        ticket_id	        UUID	    Ticket modificado (FK ‚Üí tickets)
        changed_by	        UUID	    Usuario que hizo el cambio (FK ‚Üí profiles)
        field_changed	    TEXT	    Campo modificado
        old_value	        TEXT	    Valor anterior
        new_value	        TEXT	    Nuevo valor
        change_date	        TIMESTAMP	Fecha del cambio

        üîó RELACIONES ENTRE TABLAS
            auth.users (Supabase)
                ‚Üì
            profiles (1:1 con auth.users)
                ‚Üë
            tickets.created_by / tickets.assigned_to
                ‚Üì
            comments (1:N tickets ‚Üí comments)
                ‚Üì
            ticket_history (1:N tickets ‚Üí history)
                ‚Üë
            categories (1:N categories ‚Üí tickets)


 üéØ FLUJO DEL SISTEMA
            1. Usuario se registra ‚Üí Se crea en auth.users ‚Üí Auto-crea profiles
            2. Usuario crea ticket ‚Üí Se inserta en tickets
            3. Agente asigna/comenta ‚Üí Se actualiza ticket + se crea comment
            4. Cambios importantes ‚Üí Se registran en ticket_history
            5. Ticket se resuelve ‚Üí status ‚Üí "resolved" + completed_at

üìä RESUMEN VISUAL

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    PROFILES     ‚îÇ ‚Üê Usuarios del sistema
‚îÇ  (usuarios)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    TICKETS      ‚îÇ ‚Üê Solicitudes principales
‚îÇ  (solicitudes)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   COMMENTS      ‚îÇ ‚Üê Conversaciones
‚îÇ  (comentarios)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ TICKET_HISTORY   ‚îÇ ‚Üê Auditor√≠a de cambios
‚îÇ   (historial)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚Üë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CATEGORIES     ‚îÇ ‚Üê Clasificaci√≥n
‚îÇ  (categor√≠as)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üí° DATOS IMPORTANTES
    Estados de Ticket:
    open ‚Üí Reci√©n creado

    in_progress ‚Üí Asignado y en trabajo

    resolved ‚Üí Solucionado

    closed ‚Üí Cerrado definitivo

    Roles de Usuario:
    admin ‚Üí Acceso completo

    agent ‚Üí Puede asignar/resolver tickets

    user ‚Üí Solo crear y ver sus tickets

    M√≥dulos Especializados:
    purchases ‚Üí Solicitudes de compra (usa JSONB purchase_details)

    errors ‚Üí Reporte de errores (usa JSONB error_details)

    support ‚Üí Soporte general

    other ‚Üí Otros tipos


